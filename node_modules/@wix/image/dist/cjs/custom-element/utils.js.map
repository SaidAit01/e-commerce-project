{"version":3,"names":["_imageKit","require","_utils","CSS_NUMERIC_VALUES","columnCount","columns","fontWeight","lineHeight","opacity","zIndex","zoom","pick","obj","props","propsArr","Array","isArray","reduce","subObj","prop","val","undefined","Object","assign","addDefaultUnitIfNeeded","value","toString","setStyle","node","styleProperties","keys","forEach","styleProp","propValue","style","removeProperty","exports","getScreenHeight","heightOverride","document","documentElement","clientHeight","window","innerHeight","getImageComputedProperties","extendedImageInfo","envConsts","htmlTag","targetWidth","targetHeight","imageData","uri","css","transformed","fittingType","displayMode","fittingTypes","SCALE_TO_FILL","imageOptions","quality","hasAnimation","devicePixelRatioFromData","devicePixelRatio","getDevicePixelRatio","src","id","target","width","height","pixelAspectRatio","alignment","alignType","alignTypes","CENTER","imageComputedProperties","getData","getMediaUrlByContext","staticMediaUrl","mediaRootUrl","imageUri","isExternalUrl","test","path","_exec","exec","replace","queryParams","location","search","split","map","query","devicePixelRatioQueryParam","find","_query$","toLowerCase","includes","devicePixelRatioValueForceFromUrl","Number","getImageSrc","imageNode","getAttribute","isTransformedWEBP","isTransformed","match","isWEBP","imageIsAnimated","getFileExtension","fileType","GIF","WEBP","getMediaSizeQueryString","media","entries","filter","_","key","camelToKebab","join"],"sources":["../../../src/custom-element/utils.ts"],"sourcesContent":["import {\n  alignTypes,\n  fittingTypes,\n  getData,\n  isWEBP,\n  getFileExtension,\n  fileType,\n} from '@wix/image-kit';\nimport type { ImageTransformSource, ImageDataAttributes } from '@wix/image-kit';\nimport { camelToKebab } from '../utils';\nimport { EnvConsts, MediaSizeQuery } from '../types';\nimport { CSSProperties } from 'react';\n\nconst CSS_NUMERIC_VALUES = {\n  columnCount: 1,\n  columns: 1,\n  fontWeight: 1,\n  lineHeight: 1,\n  opacity: 1,\n  zIndex: 1,\n  zoom: 1,\n};\n\nconst pick = <T extends Record<string, any>, K extends keyof T>(\n  obj: T,\n  props: K | K[],\n) => {\n  const propsArr = Array.isArray(props) ? props : [props];\n  return propsArr.reduce((subObj, prop) => {\n    const val = obj[prop];\n    return val !== undefined ? Object.assign(subObj, { [prop]: val }) : subObj;\n  }, {} as Partial<Pick<T, K>>);\n};\n\nconst addDefaultUnitIfNeeded = (\n  prop: keyof React.CSSProperties,\n  value: Exclude<CSSProperties[keyof CSSProperties], undefined>,\n): string =>\n  typeof value === 'number' &&\n  !CSS_NUMERIC_VALUES[prop as keyof typeof CSS_NUMERIC_VALUES]\n    ? `${value}px`\n    : value.toString();\n\nconst setStyle = (\n  node?: HTMLElement | HTMLImageElement,\n  styleProperties?: React.CSSProperties,\n) =>\n  node &&\n  styleProperties &&\n  Object.keys(styleProperties).forEach((prop) => {\n    const styleProp = prop as keyof React.CSSProperties;\n    const propValue = styleProperties[styleProp];\n\n    if (propValue !== undefined) {\n      node.style[styleProp as any] = addDefaultUnitIfNeeded(\n        styleProp,\n        propValue,\n      );\n    } else {\n      node.style.removeProperty(styleProp);\n    }\n  });\n\nconst getScreenHeight = (heightOverride?: number) =>\n  heightOverride ||\n  document.documentElement.clientHeight ||\n  window.innerHeight ||\n  0;\n\nconst getImageComputedProperties = (\n  extendedImageInfo: Record<string, any>,\n  envConsts: EnvConsts,\n  htmlTag: keyof JSX.IntrinsicElements,\n): ImageDataAttributes => {\n  // todo: CLNT-5323 , wixapp sildergallery proxy is generating image data without uri\n  if (\n    !extendedImageInfo.targetWidth ||\n    !extendedImageInfo.targetHeight ||\n    !extendedImageInfo.imageData.uri\n  ) {\n    return { uri: '', css: {}, transformed: false };\n  }\n\n  const { imageData } = extendedImageInfo;\n  const fittingType =\n    extendedImageInfo.displayMode || fittingTypes.SCALE_TO_FILL;\n  const imageOptions = Object.assign(\n    pick(imageData, ['upscaleMethod']),\n    pick(extendedImageInfo, ['filters', 'encoding']),\n    extendedImageInfo.quality || imageData.quality,\n    {\n      hasAnimation: extendedImageInfo?.hasAnimation || imageData?.hasAnimation,\n    },\n  );\n\n  const devicePixelRatioFromData =\n    extendedImageInfo.imageData.devicePixelRatio || envConsts.devicePixelRatio;\n  const devicePixelRatio = getDevicePixelRatio(devicePixelRatioFromData);\n\n  const src = Object.assign(\n    pick(imageData, ['width', 'height', 'crop', 'name', 'focalPoint']),\n    { id: imageData.uri },\n  ) as ImageTransformSource;\n  const target = {\n    width: extendedImageInfo.targetWidth,\n    height: extendedImageInfo.targetHeight,\n    htmlTag: (htmlTag || 'img') as 'img' | 'bg',\n    pixelAspectRatio: devicePixelRatio,\n    alignment: extendedImageInfo.alignType || alignTypes.CENTER,\n  };\n\n  const imageComputedProperties = getData(\n    fittingType,\n    src,\n    target,\n    imageOptions,\n  );\n  imageComputedProperties.uri = getMediaUrlByContext(\n    imageComputedProperties.uri as string,\n    envConsts.staticMediaUrl,\n    envConsts.mediaRootUrl,\n  );\n  return imageComputedProperties;\n};\n\nconst getMediaUrlByContext = (\n  imageUri: string,\n  staticMediaUrl: string,\n  mediaRootUrl: string,\n) => {\n  const isExternalUrl = /(^https?)|(^data)|(^blob)|(^\\/\\/)/.test(imageUri);\n\n  if (isExternalUrl) {\n    return imageUri;\n  }\n\n  let path = `${staticMediaUrl}/`;\n\n  if (imageUri) {\n    if (/^micons\\//.test(imageUri)) {\n      path = mediaRootUrl;\n    } else if (/[^.]+$/.exec(imageUri)?.[0] === 'ico') {\n      // if the image is an icon then it's taken from a slightly different place\n      path = path.replace('media', 'ficons');\n    }\n  }\n  return path + imageUri;\n};\n\nconst getDevicePixelRatio = (devicePixelRatio?: number) => {\n  // we should be able to force devicePixelRatio from url by using the query param -\n  const queryParams = window.location.search\n    .split('&')\n    .map((query) => query.split('='));\n  const devicePixelRatioQueryParam = queryParams.find((query) =>\n    query[0]?.toLowerCase().includes('devicepixelratio'),\n  );\n  const devicePixelRatioValueForceFromUrl = devicePixelRatioQueryParam?.[1]\n    ? Number(devicePixelRatioQueryParam[1])\n    : null;\n  return devicePixelRatioValueForceFromUrl || devicePixelRatio || 1;\n};\n\nconst getImageSrc = (imageNode: HTMLImageElement) =>\n  imageNode.getAttribute('src');\n\nconst isTransformedWEBP = (imageNode: HTMLImageElement, imageUri: string) => {\n  const src = getImageSrc(imageNode) || '';\n  const isTransformed = !!src.match(/.webp\\/v1\\//);\n  return isWEBP(imageUri) && isTransformed;\n};\n\nconst imageIsAnimated = (uri: string, hasAnimation?: boolean) =>\n  getFileExtension(uri) === fileType.GIF ||\n  (getFileExtension(uri) === fileType.WEBP && hasAnimation);\n\nconst getMediaSizeQueryString = (media: MediaSizeQuery) => {\n  return Object.entries(media)\n    .filter(([_, value]) => value || value === 0)\n    .map(([key, value]) => `(${camelToKebab(key)}: ${value}px)`)\n    .join(' and ');\n};\n\nexport {\n  // TODO(ameerabuf) - move methods that are not custom-element logic to a more general image util lib\n  getMediaSizeQueryString,\n  getMediaUrlByContext,\n  getScreenHeight,\n  setStyle,\n  getImageComputedProperties,\n  getImageSrc,\n  isTransformedWEBP,\n  imageIsAnimated,\n};\n"],"mappings":"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","ignoreList":[]}