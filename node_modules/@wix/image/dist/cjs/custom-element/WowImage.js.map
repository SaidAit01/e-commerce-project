{"version":3,"names":["_utils","require","_imageLayout","_interopRequireDefault","TIMEOUT","imageEffectMap","parallax","fixed","wowImageFactory","services","environmentConsts","contextWindow","WowImage","HTMLElement","constructor","_defineProperty2","default","childListObserver","timeoutId","attributeChangedCallback","_","oldValue","reLayout","connectedCallback","disableImagesLazyLoading","observeIntersect","disconnectedCallback","unobserveResize","unobserveIntersect","unobserveChildren","observedAttributes","domNodes","measures","imageId","getAttribute","imageInfo","JSON","parse","dataset","isResponsive","bgEffectName","scrollEffect","imageData","sourceSets","bgEffect","length","forEach","sourceSet","containerId","document","getElementById","containerElm","undefined","image","querySelector","picture","target","observeChildren","mutationService","measure","imageLayout","patchImage","shouldLoadImage","loadImageImmediately","mutate","patch","imageElement","ssrSrcNeedProcessing","hasSsrSrc","ssrSrcDone","getImageSrc","debounceImageLoad","clearTimeout","setTimeout","observeResize","_services$resizeServi","resizeService","observe","_services$resizeServi2","unobserve","_services$intersectio","intersectionService","_services$intersectio2","parent","MutationObserver","childList","disconnect","_default","exports"],"sources":["../../../src/custom-element/WowImage.ts"],"sourcesContent":["import { getImageSrc } from './utils';\nimport imageLayout from './imageLayout';\nimport type {\n  WixImageServices,\n  WixImageMeasures,\n  ImageInfo,\n  EnvConsts,\n} from '../types';\n\ntype Timeout = number;\n\nconst TIMEOUT = 250;\n\nconst imageEffectMap = {\n  parallax: 'ImageParallax',\n  fixed: 'ImageReveal',\n} as const;\n\nfunction wowImageFactory(\n  services: WixImageServices,\n  environmentConsts: EnvConsts,\n  contextWindow: Window & typeof globalThis,\n): any {\n  return class WowImage extends contextWindow.HTMLElement {\n    childListObserver: MutationObserver | null;\n    timeoutId: Timeout | null;\n\n    constructor() {\n      // eslint-disable-line no-useless-constructor\n      super();\n\n      this.childListObserver = null;\n      this.timeoutId = null;\n    }\n\n    attributeChangedCallback(_: string, oldValue: string) {\n      if (oldValue) {\n        this.reLayout();\n      }\n    }\n\n    connectedCallback() {\n      if (environmentConsts.disableImagesLazyLoading) {\n        this.reLayout();\n      } else {\n        this.observeIntersect();\n      }\n    }\n\n    disconnectedCallback() {\n      this.unobserveResize();\n      this.unobserveIntersect();\n      this.unobserveChildren();\n    }\n\n    static get observedAttributes() {\n      return ['data-image-info'];\n    }\n\n    reLayout() {\n      const domNodes: Record<string, HTMLElement | HTMLImageElement | null> =\n        {};\n      const measures: WixImageMeasures = {};\n      const imageId = this.getAttribute('id') as string;\n      const imageInfo: ImageInfo = JSON.parse(this.dataset.imageInfo || '');\n      const isResponsive = this.dataset.isResponsive === 'true';\n      const { bgEffectName } = this.dataset;\n      const { scrollEffect } = imageInfo.imageData;\n      const { sourceSets } = imageInfo;\n      const bgEffect =\n        bgEffectName || (scrollEffect && imageEffectMap[scrollEffect]);\n\n      if (sourceSets && sourceSets.length) {\n        sourceSets.forEach((sourceSet) => {\n          if (sourceSet.scrollEffect) {\n            sourceSet.scrollEffect =\n              imageEffectMap[\n                sourceSet.scrollEffect as keyof typeof imageEffectMap\n              ];\n          }\n        });\n      }\n\n      domNodes[imageId] = this;\n\n      if (imageInfo.containerId) {\n        domNodes[imageInfo.containerId] = contextWindow.document.getElementById(\n          `${imageInfo.containerId}`,\n        );\n      }\n      const containerElm = imageInfo.containerId\n        ? (domNodes[imageInfo.containerId] as HTMLElement)\n        : undefined;\n\n      domNodes.image = this.querySelector('img');\n      domNodes.picture = this.querySelector('picture');\n\n      if (!domNodes.image) {\n        // missing children, can't layout, wait for children to be created first\n        const target = this;\n        this.observeChildren(target);\n        return;\n      }\n\n      // clean up\n      this.unobserveChildren();\n\n      // from now on just observe changes to children of top level\n      this.observeChildren(this);\n\n      services.mutationService.measure(() => {\n        imageLayout.measure(\n          imageId,\n          measures,\n          domNodes,\n          {\n            containerElm,\n            bgEffect,\n            sourceSets,\n          },\n          services,\n        );\n      });\n\n      const patchImage = (\n        shouldLoadImage: boolean,\n        loadImageImmediately?: boolean,\n      ) => {\n        services.mutationService.mutate(() => {\n          imageLayout.patch(\n            imageId,\n            measures,\n            domNodes,\n            imageInfo,\n            environmentConsts,\n            shouldLoadImage,\n            isResponsive,\n            bgEffect,\n            loadImageImmediately,\n          );\n        });\n      };\n\n      const imageElement = domNodes.image as HTMLImageElement;\n\n      const ssrSrcNeedProcessing =\n        this.dataset.hasSsrSrc && !imageElement.dataset.ssrSrcDone;\n      // if image has no src or current src if from ssr render stage  -\n      // load the image immediately, otherwise - debounce the reload\n      const loadImageImmediately =\n        !getImageSrc(imageElement) || ssrSrcNeedProcessing;\n      if (loadImageImmediately) {\n        patchImage(true, true);\n      } else {\n        this.debounceImageLoad(patchImage);\n      }\n    }\n\n    /**\n     * Debounce consecutive image loads\n     *\n     * @param {function} patchImage closure for patching the image\n     */\n    debounceImageLoad(patchImage: (shouldLoad: boolean) => void) {\n      clearTimeout(this.timeoutId as Timeout);\n\n      this.timeoutId = contextWindow.setTimeout(() => {\n        patchImage(true);\n      }, TIMEOUT) as unknown as Timeout;\n\n      patchImage(false);\n    }\n\n    observeResize() {\n      services.resizeService?.observe(this);\n    }\n\n    unobserveResize() {\n      services.resizeService?.unobserve(this);\n    }\n\n    observeIntersect() {\n      services.intersectionService?.observe(this);\n    }\n\n    unobserveIntersect() {\n      services.intersectionService?.unobserve(this);\n    }\n\n    /**\n     * Observe DOM mutations to wait for addition of missing children\n     *\n     * @param {HTMLElement} parent\n     */\n    observeChildren(parent: HTMLElement) {\n      if (!this.childListObserver) {\n        this.childListObserver = new contextWindow.MutationObserver(() => {\n          this.reLayout();\n        });\n      }\n\n      this.childListObserver.observe(parent, { childList: true });\n    }\n\n    /**\n     * Remove DOM MutationObserver if one was created\n     */\n    unobserveChildren() {\n      if (this.childListObserver) {\n        this.childListObserver.disconnect();\n        this.childListObserver = null;\n      }\n    }\n  };\n}\n\nexport default wowImageFactory;\n"],"mappings":"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","ignoreList":[]}