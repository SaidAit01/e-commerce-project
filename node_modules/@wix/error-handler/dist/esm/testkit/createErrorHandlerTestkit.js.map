{"version":3,"names":["testkit","EventEmitter","createErrorHandlerFromEssentials","initI18n","TranslationsState","createChildEssentials","ErrorHandlerHttpClientMock","showErrorWds","ErrorHandlerSdkHttpClient","httpClient","originalSdkHttpClient","isExperiments","experiments","createErrorHandlerTestkit","options","context","getTestContext","environment","essentials","essentialsTestkit","state","renderResult","showError","props","errorHandler","jest","fn","events","Object","assign","experimentsOptions","onlineManager","onLine","webWindow","location","reload","href","window","open","artifactId","biDefaultsOverrides","createExperiments","bag","async","Promise","resolve","once","then","undefined","_skipWaitTranslations","translations","createI18n","i18nOptions","locale","language","t","key","params","getTranslateFn","sdkHttpClient","v2"],"sources":["../../../src/testkit/createErrorHandlerTestkit.ts"],"sourcesContent":["import { testkit } from '@wix/fe-essentials-standalone/testkit';\nimport { Environment } from '@wix/fe-essentials/core';\nimport { HttpClientMock } from '@wix/fe-essentials/http-client/testkit/client';\nimport { EventEmitter } from 'events';\nimport {\n  ErrorHandlerEssentials,\n  PlatformShowError,\n  PlatformShowErrorProps,\n} from '@wix/error-handler-core/types';\nimport { createErrorHandlerFromEssentials } from '../essentials/createErrorHandlerFromEssentials';\nimport { initI18n } from '@wix/fe-essentials/i18n';\nimport { TranslationsState } from '../state/TranslationsState';\nimport { TranslateAsync } from '../services/translations';\nimport { createChildEssentials } from './createChildEssentials';\nimport { ErrorHandlerHttpClientMock } from './ErrorHandlerHttpClientMock';\nimport { RenderResult } from '@testing-library/react';\nimport { showErrorWds } from './showErrorWds';\nimport { ErrorHandlerSdkHttpClient } from './SdkHttpClient';\nimport { httpClient as originalSdkHttpClient } from '@wix/essentials';\n\nfunction isExperiments(\n  experiments: any,\n): experiments is { experiments: Record<string, string> } {\n  return experiments && experiments.experiments;\n}\n\nexport interface CreateErrorHandlerTestkitOptions {\n  environment?: Partial<ErrorHandlerEssentials['environment']> &\n    Partial<Environment>;\n  biDefaultsOverrides?: ErrorHandlerEssentials['biDefaultsOverrides'];\n  experiments?: {\n    bag: Record<string, string>;\n    async?: boolean;\n  };\n  translations?: {\n    pause?: boolean;\n  };\n  showError?: PlatformShowError | 'wds';\n}\n\nexport function createErrorHandlerTestkit(\n  options: CreateErrorHandlerTestkitOptions = {},\n) {\n  const context = testkit.getTestContext({\n    environment: {\n      ...options.environment,\n    },\n  });\n\n  const essentials = context.createChildEssentials({});\n\n  const essentialsTestkit = (testkit as any).essentialsTestkit;\n\n  const state = {\n    renderResult: null as RenderResult | null,\n  };\n\n  const showError =\n    options.showError === 'wds'\n      ? (props: PlatformShowErrorProps) => {\n          state.renderResult = showErrorWds({\n            ...props,\n            errorHandler,\n          });\n        }\n      : options.showError ?? jest.fn();\n\n  const events = new EventEmitter();\n\n  Object.assign(essentials, {\n    createChildEssentials: createChildEssentials({\n      essentialsTestkit,\n      options,\n      context,\n      events,\n    }),\n  });\n\n  const experimentsOptions = options.experiments;\n\n  const onlineManager = {\n    onLine: true,\n  };\n\n  const webWindow = {\n    location: {\n      reload: () => {},\n      get href() {\n        return window.location.href;\n      },\n    },\n    open: () => {},\n  };\n\n  const errorHandler = createErrorHandlerFromEssentials(essentials, {\n    environment: {\n      artifactId: 'error-handler',\n      ...options.environment,\n    },\n    showError,\n    webWindow: webWindow as typeof window,\n    biDefaultsOverrides: options.biDefaultsOverrides,\n    onlineManager,\n    createExperiments: experimentsOptions\n      ? () => {\n          const { experiments } = essentials.createChildEssentials({\n            experiments: {\n              bag: experimentsOptions.async ? {} : experimentsOptions.bag,\n            },\n          });\n\n          if (experimentsOptions.async) {\n            new Promise((resolve) =>\n              events.once('experiments-ready', resolve),\n            ).then(() => {\n              if (isExperiments(experiments)) {\n                Object.assign(experiments.experiments, experimentsOptions.bag);\n              }\n            });\n          }\n\n          return experiments;\n        }\n      : undefined,\n  });\n\n  errorHandler._skipWaitTranslations = true;\n\n  const translations = new TranslationsState({\n    createI18n: (i18nOptions) =>\n      initI18n({\n        ...i18nOptions,\n        locale: essentials.environment.language,\n      }),\n  });\n\n  const t: TranslateAsync = async (key, params) =>\n    (await translations.getTranslateFn())(key, params);\n\n  const httpClient = new ErrorHandlerHttpClientMock(\n    essentials.httpClient as HttpClientMock,\n    errorHandler,\n  );\n\n  const sdkHttpClient = new ErrorHandlerSdkHttpClient(\n    originalSdkHttpClient,\n    errorHandler.v2,\n  );\n\n  return {\n    context,\n    essentials,\n    errorHandler,\n    showError,\n    events,\n    t,\n    onlineManager,\n    httpClient,\n    webWindow,\n    state,\n    sdkHttpClient,\n  };\n}\n"],"mappings":"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","ignoreList":[]}