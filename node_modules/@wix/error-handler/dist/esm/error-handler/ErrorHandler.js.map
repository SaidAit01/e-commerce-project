{"version":3,"names":["reportErrorBi","createErrorResolution","createBiLoggerWithDefaults","ErrorAccessor","TranslationsState","reportErrorResolutionBi","v4","uuid","reportGetResolvedErrorBi","reportShowErrorBi","CommonErrorsMapState","fallbackMessage","reportErrorRetryBi","ErrorHandlerV2","dedupeRequestId","ErrorHandler","constructor","params","_this","_defineProperty","error","options","_isErrorHandlerDisabled","errorMonitor","errorAccessor","_setErrorHandlerSessionId","requestOptions","e","console","captureException","fn","_setErrorHandlerErrorCodesMap","process","env","NODE_ENV","_skipWaitTranslations","commonErrorsMapState","getInitPromise","applicationError","validationError","httpError","errorHandlerState","errorResolution","_resolveError","resolvedError","message","action","requestId","props","platformShowError","_errorAccessor$httpEr","showErrorProps","onClick","text","undefined","environment","biDefaultsOverrides","biLogger","createErrorMonitor","dsn","experiments","createExperiments","scopes","showError","translations","onlineManager","navigator","onLine","webWindow","window","v2","sessionId","_setErrorHandlerResolvedError","errorToShow","errorCodesMap","enabled","_errorAccessor$errorH","toJSON"],"sources":["../../../src/error-handler/ErrorHandler.ts"],"sourcesContent":["import { reportErrorBi } from './reportErrorBi';\nimport type { IErrorHandler } from '@wix/fe-essentials/http-client';\nimport { createErrorResolution } from './createErrorResolution';\nimport { createBiLoggerWithDefaults } from '../util/createBiLoggerWithDefaults';\nimport {\n  ApplicationError,\n  ErrorCodesMap,\n  ErrorCodesMapConditionalEnforcement,\n  ErrorHandlerAPI,\n  ErrorHandlerEssentials,\n  HandleErrorOptions,\n  OnlineManager,\n  PlatformShowError,\n  ResolvedError,\n  ShowErrorProps,\n} from '@wix/error-handler-core/types';\nimport { ErrorAccessor } from '../state/ErrorAccessor';\nimport { TranslationsState } from '../state/TranslationsState';\nimport { reportErrorResolutionBi } from './reportErrorResolutionBi';\nimport { v4 as uuid } from 'uuid';\nimport { ErrorResolution } from '../state/ErrorResolution';\nimport { reportGetResolvedErrorBi } from './reportGetResolvedErrorBi';\nimport { reportShowErrorBi } from './reportShowErrorBi';\nimport { CommonErrorsMapState } from '../state/CommonErrorsMapState';\nimport { fallbackMessage } from '../fallbackMessage';\nimport { reportErrorRetryBi } from './reportErrorRetryBi';\nimport { ErrorHandlerV2 } from './ErrorHandlerV2';\nimport { dedupeRequestId } from '../util/dedupeRequestId';\n\nexport interface ErrorHandlerParams extends ErrorHandlerEssentials {\n  readonly showError?: PlatformShowError;\n  readonly onlineManager?: OnlineManager;\n  readonly webWindow?: typeof window;\n}\n\nexport class ErrorHandler implements IErrorHandler, ErrorHandlerAPI {\n  readonly environment;\n  readonly biDefaultsOverrides;\n  readonly biLogger;\n  readonly errorMonitor;\n  readonly experiments;\n  readonly platformShowError;\n  readonly translations;\n  readonly commonErrorsMapState;\n  readonly onlineManager: OnlineManager;\n  readonly webWindow?: Partial<typeof window>;\n  _skipWaitTranslations?: boolean;\n  v2: ErrorHandlerV2;\n\n  constructor(params: ErrorHandlerParams) {\n    this.environment = params.environment;\n    this.biDefaultsOverrides = params.biDefaultsOverrides;\n    this.biLogger = createBiLoggerWithDefaults(params);\n    this.errorMonitor = params.createErrorMonitor({\n      dsn: 'https://831e1d96e7944c6aae0c9ed9d6babd35@sentry.wixpress.com/5896',\n    });\n    this.experiments = params.createExperiments?.({\n      scopes: ['error-handler'],\n    });\n    this.platformShowError = params.showError;\n    this.translations = new TranslationsState(params);\n    this.onlineManager =\n      params.onlineManager ??\n      (typeof navigator !== 'undefined' ? navigator : { onLine: true });\n    this.webWindow =\n      params.webWindow ?? (typeof window !== 'undefined' ? window : undefined);\n    this.commonErrorsMapState = new CommonErrorsMapState(this);\n    this.v2 = new ErrorHandlerV2(this);\n  }\n\n  private _setErrorHandlerSessionId(errorAccessor: ErrorAccessor) {\n    const { errorHandlerState } = errorAccessor;\n\n    if (!errorHandlerState) {\n      return;\n    }\n\n    errorHandlerState.sessionId = uuid();\n  }\n\n  private _setErrorHandlerResolvedError(\n    errorAccessor: ErrorAccessor,\n    errorResolution: ErrorResolution,\n  ) {\n    const { errorHandlerState } = errorAccessor;\n\n    if (!errorHandlerState) {\n      return;\n    }\n\n    errorHandlerState.resolvedError = errorResolution.errorToShow;\n  }\n\n  _setErrorHandlerErrorCodesMap(\n    errorAccessor: ErrorAccessor,\n    options: {\n      errorCodesMap?: ErrorCodesMap;\n    } = {},\n  ) {\n    const { errorCodesMap } = options;\n\n    reportErrorResolutionBi(this, {\n      errorAccessor,\n      errorCodesMap,\n    });\n\n    const { errorHandlerState } = errorAccessor;\n\n    if (!errorHandlerState) {\n      return;\n    }\n\n    errorHandlerState.errorCodesMap = errorCodesMap;\n  }\n\n  private _isErrorHandlerDisabled() {\n    const { experiments } = this;\n    return (\n      experiments != null &&\n      !experiments.enabled('specs.os.EnableErrorHandlerInEditor')\n    );\n  }\n\n  handleError = (error: unknown, options: HandleErrorOptions = {}) => {\n    if (this._isErrorHandlerDisabled()) {\n      return;\n    }\n\n    const { errorMonitor } = this;\n\n    try {\n      const errorAccessor = new ErrorAccessor({ error });\n\n      this._setErrorHandlerSessionId(errorAccessor);\n\n      reportErrorBi(this, {\n        errorAccessor,\n        requestOptions: options.requestOptions,\n      });\n    } catch (e) {\n      console.error(e);\n      errorMonitor.captureException(e as Error);\n    }\n  };\n\n  _resolveError(\n    errorAccessor: ErrorAccessor,\n    options: {\n      errorCodesMap?: ErrorCodesMap;\n    } = {},\n  ) {\n    if (this._isErrorHandlerDisabled()) {\n      return;\n    }\n\n    const errorCodesMap =\n      options.errorCodesMap ?? errorAccessor.errorHandlerState?.errorCodesMap;\n\n    const errorResolution = createErrorResolution(this, {\n      errorAccessor,\n      errorCodesMap,\n    });\n\n    this._setErrorHandlerResolvedError(errorAccessor, errorResolution);\n    return errorResolution;\n  }\n\n  withErrorHandler = async <T>(\n    fn: () => Promise<T>,\n    options: {\n      errorCodesMap: ErrorCodesMapConditionalEnforcement<T>;\n    },\n  ) => {\n    try {\n      return await fn();\n    } catch (error) {\n      const errorAccessor = new ErrorAccessor({ error });\n      this._setErrorHandlerErrorCodesMap(errorAccessor, options);\n      if (process.env.NODE_ENV === 'test' && !this._skipWaitTranslations) {\n        await this.commonErrorsMapState.getInitPromise();\n      }\n      throw error;\n    }\n  };\n\n  getResolvedError = <\n    TApplicationError extends ApplicationError = ApplicationError,\n  >(\n    error: unknown,\n  ): ResolvedError<TApplicationError> => {\n    const { errorMonitor } = this;\n\n    try {\n      const errorAccessor = new ErrorAccessor({ error });\n\n      const {\n        applicationError,\n        validationError,\n        httpError,\n        errorHandlerState,\n      } = errorAccessor;\n\n      const errorResolution = this._resolveError(errorAccessor);\n\n      const resolvedError = errorHandlerState?.resolvedError;\n\n      const message = resolvedError?.message ?? fallbackMessage;\n\n      reportGetResolvedErrorBi(this, {\n        message,\n        action: resolvedError?.action,\n        errorAccessor,\n        errorResolution,\n      });\n\n      return {\n        message,\n        action: resolvedError?.action,\n        validationError,\n        applicationError: applicationError as\n          | TApplicationError\n          | undefined\n          | null,\n        httpError,\n        requestId: dedupeRequestId(httpError?.requestId),\n      };\n    } catch (e) {\n      console.error(e);\n      errorMonitor.captureException(e as Error);\n      throw e;\n    }\n  };\n\n  reportRetryAttempt = (error: unknown) => {\n    const { errorMonitor } = this;\n\n    try {\n      const errorAccessor = new ErrorAccessor({ error });\n\n      reportErrorRetryBi(this, {\n        errorAccessor,\n      });\n    } catch (e) {\n      console.error(e);\n      errorMonitor.captureException(e as Error);\n    }\n  };\n\n  showError = (error: unknown, props?: Partial<ShowErrorProps> | null) => {\n    const { platformShowError, errorMonitor } = this;\n\n    if (!platformShowError) {\n      return;\n    }\n\n    try {\n      const errorAccessor = new ErrorAccessor({ error });\n      const { errorHandlerState } = errorAccessor;\n\n      this._resolveError(errorAccessor);\n\n      const resolvedError = errorHandlerState?.resolvedError;\n\n      const showErrorProps = {\n        ...resolvedError,\n        ...props,\n      };\n\n      const message =\n        props?.message ?? resolvedError?.message ?? fallbackMessage;\n\n      const action = props?.action ?? resolvedError?.action;\n\n      reportShowErrorBi(this, {\n        message,\n        action,\n        errorAccessor,\n      });\n\n      platformShowError({\n        ...showErrorProps,\n        requestId: dedupeRequestId(errorAccessor.httpError?.requestId),\n        message,\n        action: action?.onClick\n          ? {\n              text: action.text,\n              onClick: action.onClick,\n            }\n          : undefined,\n      });\n    } catch (e) {\n      console.error(e);\n      errorMonitor.captureException(e as Error);\n    }\n  };\n\n  toJSON() {\n    return {};\n  }\n}\n"],"mappings":"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","ignoreList":[]}