{"version":3,"names":["ErrorAccessor","reportGetResolvedErrorBi","fallbackMessage","ErrorHandlerV2","constructor","errorHandler","_this","_defineProperty","fn","errorCodesMap","options","ops","validationError","statusCodeError","statusCodesOverrides","applicationError","Object","entries","reduce","acc","_ref","key","value","_","error","serverError","serverErrorOverride","response","withErrorHandler","Response","errorAccessor","_setErrorHandlerErrorCodesMap","errorHandlerState","ok","responseData","json","catch","errorMonitor","httpError","errorResolution","_resolveError","resolvedError","message","action","requestId","e","console","captureException","props","showError","reportRetryAttempt","handleError"],"sources":["../../../src/error-handler/ErrorHandlerV2.ts"],"sourcesContent":["import {\n  ErrorCodesMap,\n  ErrorHandlerAPI,\n  ResolvedError,\n  ShowErrorProps,\n  WithErrorHandlerOptions,\n} from '@wix/error-handler-core/types/v2';\nimport { ErrorAccessor } from '../state/ErrorAccessor';\nimport { reportGetResolvedErrorBi } from './reportGetResolvedErrorBi';\nimport { fallbackMessage } from '../fallbackMessage';\nimport { ErrorHandler } from './ErrorHandler';\nimport {\n  ApplicationErrorsMap,\n  ErrorCodesMap as ErrorCodesMapV1,\n  ErrorCodesMapConditionalEnforcement,\n  HandleErrorOptions,\n  ShowErrorProps as ShowErrorPropsV1,\n} from '@wix/error-handler-core/types';\n\nexport class ErrorHandlerV2 implements ErrorHandlerAPI {\n  readonly errorHandler;\n\n  constructor(errorHandler: ErrorHandler) {\n    this.errorHandler = errorHandler;\n  }\n\n  withErrorHandler = async <T>(\n    fn: () => Promise<T>,\n    errorCodesMap: ErrorCodesMap<T>,\n    options: WithErrorHandlerOptions = {},\n  ): Promise<T> => {\n    const { errorHandler } = this;\n    const ops = {\n      errorCodesMap: {\n        validationError: errorCodesMap,\n        statusCodeError: options.statusCodesOverrides,\n        applicationError: Object.entries(errorCodesMap).reduce(\n          (acc, [key, value]) => {\n            if (value) {\n              acc[key] = (_, error) => value(error) as ShowErrorPropsV1;\n            }\n            return acc;\n          },\n          {} as ApplicationErrorsMap,\n        ),\n        serverError: options.serverErrorOverride,\n      } as ErrorCodesMapV1 as ErrorCodesMapConditionalEnforcement<T>,\n    };\n\n    const response = await errorHandler.withErrorHandler(fn, ops);\n\n    if (typeof Response !== 'undefined' && response instanceof Response) {\n      const errorAccessor = new ErrorAccessor({ error: response });\n      errorHandler._setErrorHandlerErrorCodesMap(errorAccessor, ops);\n\n      const { errorHandlerState } = errorAccessor;\n      if (!response.ok && errorHandlerState) {\n        errorHandlerState.responseData = await response\n          .json()\n          .catch(() => null);\n      }\n    }\n\n    return response;\n  };\n\n  getResolvedError = <T>(error: unknown): ResolvedError & Partial<T> => {\n    const { errorHandler } = this;\n    const { errorMonitor } = errorHandler;\n\n    try {\n      const errorAccessor = new ErrorAccessor({ error });\n\n      const { httpError, errorHandlerState } = errorAccessor;\n\n      const errorResolution = errorHandler._resolveError(errorAccessor);\n\n      const resolvedError =\n        errorHandlerState?.resolvedError as Partial<ResolvedError> & Partial<T>;\n\n      const message = resolvedError?.message ?? fallbackMessage;\n      const action = resolvedError?.action;\n      const requestId = resolvedError?.requestId ?? httpError?.requestId;\n\n      reportGetResolvedErrorBi(errorHandler, {\n        message,\n        action,\n        errorAccessor,\n        errorResolution,\n      });\n\n      return {\n        message,\n        action,\n        requestId,\n        ...resolvedError,\n      };\n    } catch (e) {\n      console.error(e);\n      errorMonitor.captureException(e as Error);\n      throw e;\n    }\n  };\n\n  showError = (error: unknown, props?: Partial<ShowErrorProps> | null) => {\n    this.errorHandler.showError(error, props);\n  };\n\n  reportRetryAttempt = (error: unknown) => {\n    this.errorHandler.reportRetryAttempt(error);\n  };\n\n  handleError = (error: unknown, options?: HandleErrorOptions) => {\n    const { errorHandler } = this;\n    if (typeof Response !== 'undefined' && error instanceof Response) {\n      if (!error.ok) {\n        errorHandler.handleError(error, options);\n      }\n    } else {\n      errorHandler.handleError(error, options);\n    }\n  };\n}\n"],"mappings":"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","ignoreList":[]}