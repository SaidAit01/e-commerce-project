{"version":3,"names":["_ErrorAccessor","require","_reportGetResolvedErrorBi","_fallbackMessage","ErrorHandlerV2","constructor","errorHandler","_defineProperty2","default","fn","errorCodesMap","options","ops","validationError","statusCodeError","statusCodesOverrides","applicationError","Object","entries","reduce","acc","key","value","_","error","serverError","serverErrorOverride","response","withErrorHandler","Response","errorAccessor","ErrorAccessor","_setErrorHandlerErrorCodesMap","errorHandlerState","ok","responseData","json","catch","errorMonitor","httpError","errorResolution","_resolveError","resolvedError","message","fallbackMessage","action","requestId","reportGetResolvedErrorBi","e","console","captureException","props","showError","reportRetryAttempt","handleError","exports"],"sources":["../../../src/error-handler/ErrorHandlerV2.ts"],"sourcesContent":["import {\n  ErrorCodesMap,\n  ErrorHandlerAPI,\n  ResolvedError,\n  ShowErrorProps,\n  WithErrorHandlerOptions,\n} from '@wix/error-handler-core/types/v2';\nimport { ErrorAccessor } from '../state/ErrorAccessor';\nimport { reportGetResolvedErrorBi } from './reportGetResolvedErrorBi';\nimport { fallbackMessage } from '../fallbackMessage';\nimport { ErrorHandler } from './ErrorHandler';\nimport {\n  ApplicationErrorsMap,\n  ErrorCodesMap as ErrorCodesMapV1,\n  ErrorCodesMapConditionalEnforcement,\n  HandleErrorOptions,\n  ShowErrorProps as ShowErrorPropsV1,\n} from '@wix/error-handler-core/types';\n\nexport class ErrorHandlerV2 implements ErrorHandlerAPI {\n  readonly errorHandler;\n\n  constructor(errorHandler: ErrorHandler) {\n    this.errorHandler = errorHandler;\n  }\n\n  withErrorHandler = async <T>(\n    fn: () => Promise<T>,\n    errorCodesMap: ErrorCodesMap<T>,\n    options: WithErrorHandlerOptions = {},\n  ): Promise<T> => {\n    const { errorHandler } = this;\n    const ops = {\n      errorCodesMap: {\n        validationError: errorCodesMap,\n        statusCodeError: options.statusCodesOverrides,\n        applicationError: Object.entries(errorCodesMap).reduce(\n          (acc, [key, value]) => {\n            if (value) {\n              acc[key] = (_, error) => value(error) as ShowErrorPropsV1;\n            }\n            return acc;\n          },\n          {} as ApplicationErrorsMap,\n        ),\n        serverError: options.serverErrorOverride,\n      } as ErrorCodesMapV1 as ErrorCodesMapConditionalEnforcement<T>,\n    };\n\n    const response = await errorHandler.withErrorHandler(fn, ops);\n\n    if (typeof Response !== 'undefined' && response instanceof Response) {\n      const errorAccessor = new ErrorAccessor({ error: response });\n      errorHandler._setErrorHandlerErrorCodesMap(errorAccessor, ops);\n\n      const { errorHandlerState } = errorAccessor;\n      if (!response.ok && errorHandlerState) {\n        errorHandlerState.responseData = await response\n          .json()\n          .catch(() => null);\n      }\n    }\n\n    return response;\n  };\n\n  getResolvedError = <T>(error: unknown): ResolvedError & Partial<T> => {\n    const { errorHandler } = this;\n    const { errorMonitor } = errorHandler;\n\n    try {\n      const errorAccessor = new ErrorAccessor({ error });\n\n      const { httpError, errorHandlerState } = errorAccessor;\n\n      const errorResolution = errorHandler._resolveError(errorAccessor);\n\n      const resolvedError =\n        errorHandlerState?.resolvedError as Partial<ResolvedError> & Partial<T>;\n\n      const message = resolvedError?.message ?? fallbackMessage;\n      const action = resolvedError?.action;\n      const requestId = resolvedError?.requestId ?? httpError?.requestId;\n\n      reportGetResolvedErrorBi(errorHandler, {\n        message,\n        action,\n        errorAccessor,\n        errorResolution,\n      });\n\n      return {\n        message,\n        action,\n        requestId,\n        ...resolvedError,\n      };\n    } catch (e) {\n      console.error(e);\n      errorMonitor.captureException(e as Error);\n      throw e;\n    }\n  };\n\n  showError = (error: unknown, props?: Partial<ShowErrorProps> | null) => {\n    this.errorHandler.showError(error, props);\n  };\n\n  reportRetryAttempt = (error: unknown) => {\n    this.errorHandler.reportRetryAttempt(error);\n  };\n\n  handleError = (error: unknown, options?: HandleErrorOptions) => {\n    const { errorHandler } = this;\n    if (typeof Response !== 'undefined' && error instanceof Response) {\n      if (!error.ok) {\n        errorHandler.handleError(error, options);\n      }\n    } else {\n      errorHandler.handleError(error, options);\n    }\n  };\n}\n"],"mappings":"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","ignoreList":[]}