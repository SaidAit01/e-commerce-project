{"version":3,"names":["_testkit","require","_events","_createErrorHandlerFromEssentials","_i18n","_TranslationsState","_createChildEssentials","_ErrorHandlerHttpClientMock","_showErrorWds","_SdkHttpClient","_essentials","isExperiments","experiments","createErrorHandlerTestkit","options","context","testkit","getTestContext","environment","essentials","createChildEssentials","essentialsTestkit","state","renderResult","showError","props","showErrorWds","errorHandler","jest","fn","events","EventEmitter","Object","assign","experimentsOptions","onlineManager","onLine","webWindow","location","reload","href","window","open","createErrorHandlerFromEssentials","artifactId","biDefaultsOverrides","createExperiments","bag","async","Promise","resolve","once","then","undefined","_skipWaitTranslations","translations","TranslationsState","createI18n","i18nOptions","initI18n","locale","language","t","key","params","getTranslateFn","httpClient","ErrorHandlerHttpClientMock","sdkHttpClient","ErrorHandlerSdkHttpClient","originalSdkHttpClient","v2"],"sources":["../../../src/testkit/createErrorHandlerTestkit.ts"],"sourcesContent":["import { testkit } from '@wix/fe-essentials-standalone/testkit';\nimport { Environment } from '@wix/fe-essentials/core';\nimport { HttpClientMock } from '@wix/fe-essentials/http-client/testkit/client';\nimport { EventEmitter } from 'events';\nimport {\n  ErrorHandlerEssentials,\n  PlatformShowError,\n  PlatformShowErrorProps,\n} from '@wix/error-handler-core/types';\nimport { createErrorHandlerFromEssentials } from '../essentials/createErrorHandlerFromEssentials';\nimport { initI18n } from '@wix/fe-essentials/i18n';\nimport { TranslationsState } from '../state/TranslationsState';\nimport { TranslateAsync } from '../services/translations';\nimport { createChildEssentials } from './createChildEssentials';\nimport { ErrorHandlerHttpClientMock } from './ErrorHandlerHttpClientMock';\nimport { RenderResult } from '@testing-library/react';\nimport { showErrorWds } from './showErrorWds';\nimport { ErrorHandlerSdkHttpClient } from './SdkHttpClient';\nimport { httpClient as originalSdkHttpClient } from '@wix/essentials';\n\nfunction isExperiments(\n  experiments: any,\n): experiments is { experiments: Record<string, string> } {\n  return experiments && experiments.experiments;\n}\n\nexport interface CreateErrorHandlerTestkitOptions {\n  environment?: Partial<ErrorHandlerEssentials['environment']> &\n    Partial<Environment>;\n  biDefaultsOverrides?: ErrorHandlerEssentials['biDefaultsOverrides'];\n  experiments?: {\n    bag: Record<string, string>;\n    async?: boolean;\n  };\n  translations?: {\n    pause?: boolean;\n  };\n  showError?: PlatformShowError | 'wds';\n}\n\nexport function createErrorHandlerTestkit(\n  options: CreateErrorHandlerTestkitOptions = {},\n) {\n  const context = testkit.getTestContext({\n    environment: {\n      ...options.environment,\n    },\n  });\n\n  const essentials = context.createChildEssentials({});\n\n  const essentialsTestkit = (testkit as any).essentialsTestkit;\n\n  const state = {\n    renderResult: null as RenderResult | null,\n  };\n\n  const showError =\n    options.showError === 'wds'\n      ? (props: PlatformShowErrorProps) => {\n          state.renderResult = showErrorWds({\n            ...props,\n            errorHandler,\n          });\n        }\n      : options.showError ?? jest.fn();\n\n  const events = new EventEmitter();\n\n  Object.assign(essentials, {\n    createChildEssentials: createChildEssentials({\n      essentialsTestkit,\n      options,\n      context,\n      events,\n    }),\n  });\n\n  const experimentsOptions = options.experiments;\n\n  const onlineManager = {\n    onLine: true,\n  };\n\n  const webWindow = {\n    location: {\n      reload: () => {},\n      get href() {\n        return window.location.href;\n      },\n    },\n    open: () => {},\n  };\n\n  const errorHandler = createErrorHandlerFromEssentials(essentials, {\n    environment: {\n      artifactId: 'error-handler',\n      ...options.environment,\n    },\n    showError,\n    webWindow: webWindow as typeof window,\n    biDefaultsOverrides: options.biDefaultsOverrides,\n    onlineManager,\n    createExperiments: experimentsOptions\n      ? () => {\n          const { experiments } = essentials.createChildEssentials({\n            experiments: {\n              bag: experimentsOptions.async ? {} : experimentsOptions.bag,\n            },\n          });\n\n          if (experimentsOptions.async) {\n            new Promise((resolve) =>\n              events.once('experiments-ready', resolve),\n            ).then(() => {\n              if (isExperiments(experiments)) {\n                Object.assign(experiments.experiments, experimentsOptions.bag);\n              }\n            });\n          }\n\n          return experiments;\n        }\n      : undefined,\n  });\n\n  errorHandler._skipWaitTranslations = true;\n\n  const translations = new TranslationsState({\n    createI18n: (i18nOptions) =>\n      initI18n({\n        ...i18nOptions,\n        locale: essentials.environment.language,\n      }),\n  });\n\n  const t: TranslateAsync = async (key, params) =>\n    (await translations.getTranslateFn())(key, params);\n\n  const httpClient = new ErrorHandlerHttpClientMock(\n    essentials.httpClient as HttpClientMock,\n    errorHandler,\n  );\n\n  const sdkHttpClient = new ErrorHandlerSdkHttpClient(\n    originalSdkHttpClient,\n    errorHandler.v2,\n  );\n\n  return {\n    context,\n    essentials,\n    errorHandler,\n    showError,\n    events,\n    t,\n    onlineManager,\n    httpClient,\n    webWindow,\n    state,\n    sdkHttpClient,\n  };\n}\n"],"mappings":"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","ignoreList":[]}